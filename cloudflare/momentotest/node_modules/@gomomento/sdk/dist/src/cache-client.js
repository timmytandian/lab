"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.SimpleCacheClient = exports.CacheClient = void 0;
const cache_control_client_1 = require("./internal/cache-control-client");
const cache_data_client_1 = require("./internal/cache-data-client");
const _1 = require(".");
const utils_1 = require("@gomomento/sdk-core/dist/src/internal/utils");
const AbstractCacheClient_1 = require("@gomomento/sdk-core/dist/src/internal/clients/cache/AbstractCacheClient");
const EAGER_CONNECTION_DEFAULT_TIMEOUT_SECONDS = 30;
/**
 * Momento Cache Client.
 *
 * Features include:
 * - Get, set, and delete data
 * - Create, delete, and list caches
 * - Create, revoke, and list signing keys
 */
class CacheClient extends AbstractCacheClient_1.AbstractCacheClient {
    /**
     * Creates an instance of CacheClient.
     * @param {CacheClientProps} props configuration and credentials for creating a CacheClient.
     */
    constructor(props) {
        var _a;
        (0, utils_1.validateTtlSeconds)(props.defaultTtlSeconds);
        const configuration = (_a = props.configuration) !== null && _a !== void 0 ? _a : getDefaultCacheClientConfiguration();
        const propsWithConfig = {
            ...props,
            configuration: configuration,
        };
        const controlClient = new cache_control_client_1.CacheControlClient({
            configuration: configuration,
            credentialProvider: props.credentialProvider,
        });
        const numClients = configuration
            .getTransportStrategy()
            .getGrpcConfig()
            .getNumClients();
        const dataClients = (0, utils_1.range)(numClients).map((_, id) => new cache_data_client_1.CacheDataClient(propsWithConfig, String(id)));
        super(controlClient, dataClients);
        this.notYetAbstractedControlClient = controlClient;
        this.logger = configuration.getLoggerFactory().getLogger(this);
        this.logger.debug('Creating Momento CacheClient');
    }
    /**
     * Creates a new instance of CacheClient. If eagerConnectTimeout is present in the given props, the client will
     * eagerly create its connection to Momento. It will wait until the connection is established, or until the timout
     * runs out. It the timeout runs out, the client will be valid to use, but it may still be connecting in the background.
     * @param {EagerCacheClientProps} props configuration and credentials for creating a CacheClient.
     */
    static async create(props) {
        const client = new CacheClient(props);
        const timeout = props.eagerConnectTimeout !== undefined
            ? props.eagerConnectTimeout
            : EAGER_CONNECTION_DEFAULT_TIMEOUT_SECONDS;
        // eslint-disable-next-line @typescript-eslint/no-unsafe-call
        (0, utils_1.validateTimeout)(timeout);
        // client need to explicitly set the value as 0 to disable eager connection.
        if (props.eagerConnectTimeout !== 0) {
            await Promise.all(client.dataClients.map(dc => dc.connect(timeout)));
        }
        return client;
    }
    /**
     * Flushes / clears all the items of the given cache
     *
     * @param {string} cacheName - The cache to be flushed.
     * @returns {Promise<CacheFlush.Response>} -
     * {@link CacheFlush.Success} on success.
     * {@link CacheFlush.Error} on failure.
     */
    async flushCache(cacheName) {
        return await this.notYetAbstractedControlClient.flushCache(cacheName);
    }
    /**
     * Creates a Momento signing key.
     *
     * @param {number} ttlMinutes - The time to live in minutes until the Momento
     * signing key expires.
     * @returns {Promise<CreateSigningKey.Response>} -
     * {@link CreateSigningKey.Success} containing the key, key ID, endpoint, and
     * expiration date on success.
     * {@link CreateSigningKey.Error} on failure.
     */
    async createSigningKey(ttlMinutes) {
        const client = this.getNextDataClient();
        return await this.notYetAbstractedControlClient.createSigningKey(ttlMinutes, client.getEndpoint());
    }
    /**
     * Revokes a Momento signing key.
     *
     * @remarks
     * All tokens signed by this key will be invalid.
     *
     * @param {string} keyId - The ID of the key to revoke.
     * @returns {Promise<RevokeSigningKey.Response>} -
     * {@link RevokeSigningKey.Success} on success.
     * {@link RevokeSigningKey.Error} on failure.
     */
    async revokeSigningKey(keyId) {
        return await this.notYetAbstractedControlClient.revokeSigningKey(keyId);
    }
    /**
     * Lists all Momento signing keys for the provided auth token.
     *
     * @returns {Promise<ListSigningKeys.Response>} -
     * {@link ListSigningKeys.Success} containing the keys on success.
     * {@link ListSigningKeys.Error} on failure.
     */
    async listSigningKeys() {
        const client = this.getNextDataClient();
        return await this.notYetAbstractedControlClient.listSigningKeys(client.getEndpoint());
    }
    getNextDataClient() {
        const client = this.dataClients[this.nextDataClientIndex];
        this.nextDataClientIndex =
            (this.nextDataClientIndex + 1) % this.dataClients.length;
        return client;
    }
}
exports.CacheClient = CacheClient;
function getDefaultCacheClientConfiguration() {
    const config = _1.Configurations.Laptop.latest();
    const logger = config.getLoggerFactory().getLogger('CacheClient');
    logger.info('No configuration provided to CacheClient. Using default "Laptop" configuration, suitable for development. For production use, consider specifying an explicit configuration.');
    return config;
}
/**
 * @deprecated use {CacheClient} instead
 */
class SimpleCacheClient extends CacheClient {
}
exports.SimpleCacheClient = SimpleCacheClient;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FjaGUtY2xpZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2NhY2hlLWNsaWVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSwwRUFBbUU7QUFDbkUsb0VBQTZEO0FBQzdELHdCQVFXO0FBRVgsdUVBSXFEO0FBRXJELGlIQUE0RztBQUc1RyxNQUFNLHdDQUF3QyxHQUFHLEVBQUUsQ0FBQztBQUVwRDs7Ozs7OztHQU9HO0FBQ0gsTUFBYSxXQUFZLFNBQVEseUNBQW1CO0lBR2xEOzs7T0FHRztJQUNILFlBQVksS0FBdUI7O1FBQ2pDLElBQUEsMEJBQWtCLEVBQUMsS0FBSyxDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFDNUMsTUFBTSxhQUFhLEdBQ2pCLE1BQUEsS0FBSyxDQUFDLGFBQWEsbUNBQUksa0NBQWtDLEVBQUUsQ0FBQztRQUU5RCxNQUFNLGVBQWUsR0FBK0I7WUFDbEQsR0FBRyxLQUFLO1lBQ1IsYUFBYSxFQUFFLGFBQWE7U0FDN0IsQ0FBQztRQUVGLE1BQU0sYUFBYSxHQUFHLElBQUkseUNBQWtCLENBQUM7WUFDM0MsYUFBYSxFQUFFLGFBQWE7WUFDNUIsa0JBQWtCLEVBQUUsS0FBSyxDQUFDLGtCQUFrQjtTQUM3QyxDQUFDLENBQUM7UUFFSCxNQUFNLFVBQVUsR0FBRyxhQUFhO2FBQzdCLG9CQUFvQixFQUFFO2FBQ3RCLGFBQWEsRUFBRTthQUNmLGFBQWEsRUFBRSxDQUFDO1FBQ25CLE1BQU0sV0FBVyxHQUFHLElBQUEsYUFBSyxFQUFDLFVBQVUsQ0FBQyxDQUFDLEdBQUcsQ0FDdkMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxJQUFJLG1DQUFlLENBQUMsZUFBZSxFQUFFLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUM1RCxDQUFDO1FBQ0YsS0FBSyxDQUFDLGFBQWEsRUFBRSxXQUFXLENBQUMsQ0FBQztRQUVsQyxJQUFJLENBQUMsNkJBQTZCLEdBQUcsYUFBYSxDQUFDO1FB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aWVudH0gZnJvbSAnLi9pbnRlcm5hbC9jYWNoZS1jb250cm9sLWNsaWVudCc7XG5pbXBvcnQge0NhY2hlRGF0YUNsaWVudH0gZnJvbSAnLi9pbnRlcm5hbC9jYWNoZS1kYXRhLWNsaWVudCc7XG5pbXBvcnQge1xuICBDcmVhdGVTaWduaW5nS2V5LFxuICBMaXN0U2lnbmluZ0tleXMsXG4gIFJldm9rZVNpZ25pbmdLZXksXG4gIENhY2hlRmx1c2gsXG4gIE1vbWVudG9Mb2dnZXIsXG4gIENvbmZpZ3VyYXRpb24sXG4gIENvbmZpZ3VyYXRpb25zLFxufSBmcm9tICcuJztcbmltcG9ydCB7Q2FjaGVDbGllbnRQcm9wcywgRWFnZXJDYWNoZUNsaWVudFByb3BzfSBmcm9tICcuL2NhY2hlLWNsaWVudC1wcm9wcyc7XG5pbXBvcnQge1xuICByYW5nZSxcbiAgdmFsaWRhdGVUaW1lb3V0LFxuICB2YWxpZGF0ZVR0bFNlY29uZHMsXG59IGZyb20gJ0Bnb21vbWVudG8vc2RrLWNvcmUvZGlzdC9zcmMvaW50ZXJuYWwvdXRpbHMnO1xuaW1wb3J0IHtJQ2FjaGVDbGllbnR9IGZyb20gJ0Bnb21vbWVudG8vc2RrLWNvcmUvZGlzdC9zcmMvY2xpZW50cy9JQ2FjaGVDbGllbnQnO1xuaW1wb3J0IHtBYnN0cmFjdENhY2hlQ2xpZW50fSBmcm9tICdAZ29tb21lbnRvL3Nkay1jb3JlL2Rpc3Qvc3JjL2ludGVybmFsL2NsaWVudHMvY2FjaGUvQWJzdHJhY3RDYWNoZUNsaWVudCc7XG5pbXBvcnQge0NhY2hlQ2xpZW50UHJvcHNXaXRoQ29uZmlnfSBmcm9tICcuL2ludGVybmFsL2NhY2hlLWNsaWVudC1wcm9wcy13aXRoLWNvbmZpZyc7XG5cbmNvbnN0IEVBR0VSX0NPTk5FQ1RJT05fREVGQVVMVF9USU1FT1VUX1NFQ09ORFMgPSAzMDtcblxuLyoqXG4gKiBNb21lbnRvIENhY2hlIENsaWVudC5cbiAqXG4gKiBGZWF0dXJlcyBpbmNsdWRlOlxuICogLSBHZXQsIHNldCwgYW5kIGRlbGV0ZSBkYXRhXG4gKiAtIENyZWF0ZSwgZGVsZXRlLCBhbmQgbGlzdCBjYWNoZXNcbiAqIC0gQ3JlYXRlLCByZXZva2UsIGFuZCBsaXN0IHNpZ25pbmcga2V5c1xuICovXG5leHBvcnQgY2xhc3MgQ2FjaGVDbGllbnQgZXh0ZW5kcyBBYnN0cmFjdENhY2hlQ2xpZW50IGltcGxlbWVudHMgSUNhY2hlQ2xpZW50IHtcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXI6IE1vbWVudG9Mb2dnZXI7XG4gIHByaXZhdGUgcmVhZG9ubHkgbm90WWV0QWJzdHJhY3RlZENvbnRyb2xDbGllbnQ6IENhY2hlQ29udHJvbENsaWVudDtcbiAgLyoqXG4gICAqIENyZWF0ZXMgYW4gaW5zdGFuY2Ugb2YgQ2FjaGVDbGllbnQuXG4gICAqIEBwYXJhbSB7Q2FjaGVDbGllbnRQcm9wc30gcHJvcHMgY29uZmlndXJhdGlvbiBhbmQgY3JlZGVudGlhbHMgZm9yIGNyZWF0aW5nIGEgQ2FjaGVDbGllbnQuXG4gICAqL1xuICBjb25zdHJ1Y3Rvcihwcm9wczogQ2FjaGVDbGllbnRQcm9wcykge1xuICAgIHZhbGlkYXRlVHRsU2Vjb25kcyhwcm9wcy5kZWZhdWx0VHRsU2Vjb25kcyk7XG4gICAgY29uc3QgY29uZmlndXJhdGlvbjogQ29uZmlndXJhdGlvbiA9XG4gICAgICBwcm9wcy5jb25maWd1cmF0aW9uID8/IGdldERlZmF1bHRDYWNoZUNsaWVudENvbmZpZ3VyYXRpb24oKTtcblxuICAgIGNvbnN0IHByb3BzV2l0aENvbmZpZzogQ2FjaGVDbGllbnRQcm9wc1dpdGhDb25maWcgPSB7XG4gICAgICAuLi5wcm9wcyxcbiAgICAgIGNvbmZpZ3VyYXRpb246IGNvbmZpZ3VyYXRpb24sXG4gICAgfTtcblxuICAgIGNvbnN0IGNvbnRyb2xDbGllbnQgPSBuZXcgQ2FjaGVDb250cm9sQ2xpZW50KHtcbiAgICAgIGNvbmZpZ3VyYXRpb246IGNvbmZpZ3VyYXRpb24sXG4gICAgICBjcmVkZW50aWFsUHJvdmlkZXI6IHByb3BzLmNyZWRlbnRpYWxQcm92aWRlcixcbiAgICB9KTtcblxuICAgIGNvbnN0IG51bUNsaWVudHMgPSBjb25maWd1cmF0aW9uXG4gICAgICAuZ2V0VHJhbnNwb3J0U3RyYXRlZ3koKVxuICAgICAgLmdldEdycGNDb25maWcoKVxuICAgICAgLmdldE51bUNsaWVudHMoKTtcbiAgICBjb25zdCBkYXRhQ2xpZW50cyA9IHJhbmdlKG51bUNsaWVudHMpLm1hcChcbiAgICAgIChfLCBpZCkgPT4gbmV3IENhY2hlRGF0YUNsaWVudChwcm9wc1dpdGhDb25maWcsIFN0cmluZyhpZCkpXG4gICAgKTtcbiAgICBzdXBlcihjb250cm9sQ2xpZW50LCBkYXRhQ2xpZW50cyk7XG5cbiAgICB0aGlzLm5vdFlldEFic3RyYWN0ZWRDb250cm9sQ2xpZW50ID0gY29udHJvbENsaWVudDtcblxuICAgIHRoaXMubG9nZ2VyID0gY29uZmlndXJhdGlvbi5nZXRMb2dnZXJGYWN0b3J5KCkuZ2V0TG9nZ2VyKHRoaXMpO1xuICAgIHRoaXMubG9nZ2VyLmRlYnVnKCdDcmVhdGluZyBNb21lbnRvIENhY2hlQ2xpZW50Jyk7XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlcyBhIG5ldyBpbnN0YW5jZSBvZiBDYWNoZUNsaWVudC4gSWYgZWFnZXJDb25uZWN0VGltZW91dCBpcyBwcmVzZW50IGluIHRoZSBnaXZlbiBwcm9wcywgdGhlIGNsaWVudCB3aWxsXG4gICAqIGVhZ2VybHkgY3JlYXRlIGl0cyBjb25uZWN0aW9uIHRvIE1vbWVudG8uIEl0IHdpbGwgd2FpdCB1bnRpbCB0aGUgY29ubmVjdGlvbiBpcyBlc3RhYmxpc2hlZCwgb3IgdW50aWwgdGhlIHRpbW91dFxuICAgKiBydW5zIG91dC4gSXQgdGhlIHRpbWVvdXQgcnVucyBvdXQsIHRoZSBjbGllbnQgd2lsbCBiZSB2YWxpZCB0byB1c2UsIGJ1dCBpdCBtYXkgc3RpbGwgYmUgY29ubmVjdGluZyBpbiB0aGUgYmFja2dyb3VuZC5cbiAgICogQHBhcmFtIHtFYWdlckNhY2hlQ2xpZW50UHJvcHN9IHByb3BzIGNvbmZpZ3VyYXRpb24gYW5kIGNyZWRlbnRpYWxzIGZvciBjcmVhdGluZyBhIENhY2hlQ2xpZW50LlxuICAgKi9cbiAgc3RhdGljIGFzeW5jIGNyZWF0ZShwcm9wczogRWFnZXJDYWNoZUNsaWVudFByb3BzKTogUHJvbWlzZTxDYWNoZUNsaWVudD4ge1xuICAgIGNvbnN0IGNsaWVudCA9IG5ldyBDYWNoZUNsaWVudChwcm9wcyk7XG4gICAgY29uc3QgdGltZW91dCA9XG4gICAgICBwcm9wcy5lYWdlckNvbm5lY3RUaW1lb3V0ICE9PSB1bmRlZmluZWRcbiAgICAgICAgPyBwcm9wcy5lYWdlckNvbm5lY3RUaW1lb3V0XG4gICAgICAgIDogRUFHRVJfQ09OTkVDVElPTl9ERUZBVUxUX1RJTUVPVVRfU0VDT05EUztcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXVuc2FmZS1jYWxsXG4gICAgdmFsaWRhdGVUaW1lb3V0KHRpbWVvdXQpO1xuICAgIC8vIGNsaWVudCBuZWVkIHRvIGV4cGxpY2l0bHkgc2V0IHRoZSB2YWx1ZSBhcyAwIHRvIGRpc2FibGUgZWFnZXIgY29ubmVjdGlvbi5cbiAgICBpZiAocHJvcHMuZWFnZXJDb25uZWN0VGltZW91dCAhPT0gMCkge1xuICAgICAgYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgICAgIGNsaWVudC5kYXRhQ2xpZW50cy5tYXAoZGMgPT4gKGRjIGFzIENhY2hlRGF0YUNsaWVudCkuY29ubmVjdCh0aW1lb3V0KSlcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiBjbGllbnQ7XG4gIH1cblxuICAvKipcbiAgICogRmx1c2hlcyAvIGNsZWFycyBhbGwgdGhlIGl0ZW1zIG9mIHRoZSBnaXZlbiBjYWNoZVxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gY2FjaGVOYW1lIC0gVGhlIGNhY2hlIHRvIGJlIGZsdXNoZWQuXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPENhY2hlRmx1c2guUmVzcG9uc2U+fSAtXG4gICAqIHtAbGluayBDYWNoZUZsdXNoLlN1Y2Nlc3N9IG9uIHN1Y2Nlc3MuXG4gICAqIHtAbGluayBDYWNoZUZsdXNoLkVycm9yfSBvbiBmYWlsdXJlLlxuICAgKi9cbiAgcHVibGljIGFzeW5jIGZsdXNoQ2FjaGUoY2FjaGVOYW1lOiBzdHJpbmcpOiBQcm9taXNlPENhY2hlRmx1c2guUmVzcG9uc2U+IHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5ub3RZZXRBYnN0cmFjdGVkQ29udHJvbENsaWVudC5mbHVzaENhY2hlKGNhY2hlTmFtZSk7XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlcyBhIE1vbWVudG8gc2lnbmluZyBrZXkuXG4gICAqXG4gICAqIEBwYXJhbSB7bnVtYmVyfSB0dGxNaW51dGVzIC0gVGhlIHRpbWUgdG8gbGl2ZSBpbiBtaW51dGVzIHVudGlsIHRoZSBNb21lbnRvXG4gICAqIHNpZ25pbmcga2V5IGV4cGlyZXMuXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPENyZWF0ZVNpZ25pbmdLZXkuUmVzcG9uc2U+fSAtXG4gICAqIHtAbGluayBDcmVhdGVTaWduaW5nS2V5LlN1Y2Nlc3N9IGNvbnRhaW5pbmcgdGhlIGtleSwga2V5IElELCBlbmRwb2ludCwgYW5kXG4gICAqIGV4cGlyYXRpb24gZGF0ZSBvbiBzdWNjZXNzLlxuICAgKiB7QGxpbmsgQ3JlYXRlU2lnbmluZ0tleS5FcnJvcn0gb24gZmFpbHVyZS5cbiAgICovXG4gIHB1YmxpYyBhc3luYyBjcmVhdGVTaWduaW5nS2V5KFxuICAgIHR0bE1pbnV0ZXM6IG51bWJlclxuICApOiBQcm9taXNlPENyZWF0ZVNpZ25pbmdLZXkuUmVzcG9uc2U+IHtcbiAgICBjb25zdCBjbGllbnQgPSB0aGlzLmdldE5leHREYXRhQ2xpZW50KCk7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMubm90WWV0QWJzdHJhY3RlZENvbnRyb2xDbGllbnQuY3JlYXRlU2lnbmluZ0tleShcbiAgICAgIHR0bE1pbnV0ZXMsXG4gICAgICBjbGllbnQuZ2V0RW5kcG9pbnQoKVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogUmV2b2tlcyBhIE1vbWVudG8gc2lnbmluZyBrZXkuXG4gICAqXG4gICAqIEByZW1hcmtzXG4gICAqIEFsbCB0b2tlbnMgc2lnbmVkIGJ5IHRoaXMga2V5IHdpbGwgYmUgaW52YWxpZC5cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IGtleUlkIC0gVGhlIElEIG9mIHRoZSBrZXkgdG8gcmV2b2tlLlxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTxSZXZva2VTaWduaW5nS2V5LlJlc3BvbnNlPn0gLVxuICAgKiB7QGxpbmsgUmV2b2tlU2lnbmluZ0tleS5TdWNjZXNzfSBvbiBzdWNjZXNzLlxuICAgKiB7QGxpbmsgUmV2b2tlU2lnbmluZ0tleS5FcnJvcn0gb24gZmFpbHVyZS5cbiAgICovXG4gIHB1YmxpYyBhc3luYyByZXZva2VTaWduaW5nS2V5KFxuICAgIGtleUlkOiBzdHJpbmdcbiAgKTogUHJvbWlzZTxSZXZva2VTaWduaW5nS2V5LlJlc3BvbnNlPiB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMubm90WWV0QWJzdHJhY3RlZENvbnRyb2xDbGllbnQucmV2b2tlU2lnbmluZ0tleShrZXlJZCk7XG4gIH1cblxuICAvKipcbiAgICogTGlzdHMgYWxsIE1vbWVudG8gc2lnbmluZyBrZXlzIGZvciB0aGUgcHJvdmlkZWQgYXV0aCB0b2tlbi5cbiAgICpcbiAgICogQHJldHVybnMge1Byb21pc2U8TGlzdFNpZ25pbmdLZXlzLlJlc3BvbnNlPn0gLVxuICAgKiB7QGxpbmsgTGlzdFNpZ25pbmdLZXlzLlN1Y2Nlc3N9IGNvbnRhaW5pbmcgdGhlIGtleXMgb24gc3VjY2Vzcy5cbiAgICoge0BsaW5rIExpc3RTaWduaW5nS2V5cy5FcnJvcn0gb24gZmFpbHVyZS5cbiAgICovXG4gIHB1YmxpYyBhc3luYyBsaXN0U2lnbmluZ0tleXMoKTogUHJvbWlzZTxMaXN0U2lnbmluZ0tleXMuUmVzcG9uc2U+IHtcbiAgICBjb25zdCBjbGllbnQgPSB0aGlzLmdldE5leHREYXRhQ2xpZW50KCk7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMubm90WWV0QWJzdHJhY3RlZENvbnRyb2xDbGllbnQubGlzdFNpZ25pbmdLZXlzKFxuICAgICAgY2xpZW50LmdldEVuZHBvaW50KClcbiAgICApO1xuICB9XG5cbiAgcHJvdGVjdGVkIGdldE5leHREYXRhQ2xpZW50KCk6IENhY2hlRGF0YUNsaWVudCB7XG4gICAgY29uc3QgY2xpZW50ID0gdGhpcy5kYXRhQ2xpZW50c1t0aGlzLm5leHREYXRhQ2xpZW50SW5kZXhdO1xuICAgIHRoaXMubmV4dERhdGFDbGllbnRJbmRleCA9XG4gICAgICAodGhpcy5uZXh0RGF0YUNsaWVudEluZGV4ICsgMSkgJSB0aGlzLmRhdGFDbGllbnRzLmxlbmd0aDtcbiAgICByZXR1cm4gY2xpZW50IGFzIENhY2hlRGF0YUNsaWVudDtcbiAgfVxufVxuXG5mdW5jdGlvbiBnZXREZWZhdWx0Q2FjaGVDbGllbnRDb25maWd1cmF0aW9uKCk6IENvbmZpZ3VyYXRpb24ge1xuICBjb25zdCBjb25maWcgPSBDb25maWd1cmF0aW9ucy5MYXB0b3AubGF0ZXN0KCk7XG4gIGNvbnN0IGxvZ2dlciA9IGNvbmZpZy5nZXRMb2dnZXJGYWN0b3J5KCkuZ2V0TG9nZ2VyKCdDYWNoZUNsaWVudCcpO1xuICBsb2dnZXIuaW5mbyhcbiAgICAnTm8gY29uZmlndXJhdGlvbiBwcm92aWRlZCB0byBDYWNoZUNsaWVudC4gVXNpbmcgZGVmYXVsdCBcIkxhcHRvcFwiIGNvbmZpZ3VyYXRpb24sIHN1aXRhYmxlIGZvciBkZXZlbG9wbWVudC4gRm9yIHByb2R1Y3Rpb24gdXNlLCBjb25zaWRlciBzcGVjaWZ5aW5nIGFuIGV4cGxpY2l0IGNvbmZpZ3VyYXRpb24uJ1xuICApO1xuICByZXR1cm4gY29uZmlnO1xufVxuXG4vKipcbiAqIEBkZXByZWNhdGVkIHVzZSB7Q2FjaGVDbGllbnR9IGluc3RlYWRcbiAqL1xuZXhwb3J0IGNsYXNzIFNpbXBsZUNhY2hlQ2xpZW50IGV4dGVuZHMgQ2FjaGVDbGllbnQge31cbiJdfQ==